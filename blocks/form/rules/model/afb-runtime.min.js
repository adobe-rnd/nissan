/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
* Copyright 2022 Adobe
* All Rights Reserved.
*
* NOTICE: All information contained herein is, and remains
* the property of Adobe and its suppliers, if any. The intellectual
* and technical concepts contained herein are proprietary to Adobe
* and its suppliers and are protected by all applicable intellectual
* property laws, including trade secret and copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe.

* Adobe permits you to use and modify this file solely in accordance with
* the terms of the Adobe license agreement accompanying it.
*************************************************************************/

import{E as e,p as t,a as n,I as i,R as s,C as r,F as a,b as o,c as l,V as u,d,g as h,e as c,f as p,h as m,S as f,i as g,j as _,k as y,l as v,m as b,n as M,o as j,q as x,A as E,r as w,s as D}from"./Events-a66f7a2c-aea0619d.js";import $ from"../formula/index.min.js";import{format as T,parseDefaultDate as N,datetimeToNumber as I,parseDateSkeleton as O,formatDate as F,numberToDatetime as k}from"./afb-formatters.min.js";function C(e,t,n,i){var s,r=arguments.length,a=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,i);else for(var o=e.length-1;o>=0;o--)(s=e[o])&&(a=(r<3?s(a):r>3?s(t,n,a):s(t,n))||a);return r>3&&a&&Object.defineProperty(t,n,a),a}const S=e=>new Map(Object.entries(e)),R=S({date:"date-input","data-url":"file-input",binary:"file-input"}),A=S({number:"number-input",boolean:"checkbox",object:"panel",array:"panel",file:"file-input","file[]":"file-input"}),P=["string[]","boolean[]","number[]","array"],q=e=>{const t=e.type||"string";if("enum"in e){return e.enum.length>2||P.indexOf(t)>-1?"drop-down":"checkbox"}return"string"===t||"string[]"===t?R.get(e.format)||"text-input":A.get(t)||"text-input"},V=function(e){return"file"===e?.type||"file[]"===e?.type||("string"===e?.type||"string[]"===e?.type)&&("binary"===e?.format||"data-url"===e?.format)};function z(e,t){let n;return e instanceof Array?(n=[],n=e.map((e=>z(e,t)))):"object"==typeof e&&null!==e?(n={},Object.entries(e).forEach((([e,i])=>{n[e]=z(i,t)}))):n=e,t&&n&&n.id&&(n.id=t()),n}const U=e=>JSON.stringify(e,null,2),L=e=>e.repeatable&&(void 0===e.minOccur&&void 0===e.maxOccur||void 0!==e.minOccur&&void 0!==e.maxOccur&&0!==e.maxOccur||void 0!==e.minOccur&&void 0!==e.maxOccur&&0!==e.minOccur&&0!==e.maxOccur||void 0!==e.minOccur&&e.minOccur>=0||void 0!==e.maxOccur&&0!==e.maxOccur)||!1;class Q{$_name;$_value;$_type;$_fields=[];parent;constructor(e,t,n=typeof t,i){this.$_name=e,this.$_value=t,this.$_type=n,this.parent=i}valueOf(){return this.$_value}get $name(){return this.$_name}get $value(){if(this.$_fields.find((e=>!1!==e.enabled))||!this.$_fields.length)return this.$_value}setValue(e,t,n){this.$_value=e,this.$_fields.forEach((e=>{n!==e&&(e.value=t)}))}get $type(){return this.$_type}$bindToField(e){-1===this.$_fields.indexOf(e)&&this.$_fields.push(e)}$convertToDataValue(){return this}get $isDataGroup(){return!1}}const B=Symbol("NullValue");const W=new class extends Q{constructor(){super("",B,"null")}setValue(){}$bindToField(){}$length(){return 0}$convertToDataValue(){return this}$addDataNode(){}$removeDataNode(){}$getDataNode(){return this}$containsDataNode(){return!1}};class G extends Q{$_items;createEntry(e,t,n){const i=Array.isArray(t)?"array":typeof t;return"object"==typeof t&&null!=t?new G(e,t,i,n):new Q(e,t,i,n)}constructor(e,t,n=typeof t,i){super(e,t,n,i),this.$_items=t instanceof Array?t.map(((e,t)=>this.createEntry(t,e,this))):Object.fromEntries(Object.entries(t).map((([e,t])=>[e,this.createEntry(e,t,this)])))}get $value(){return!this.$_fields.find((e=>!1!==e.enabled))&&this.$_fields.length?"array"===this.$type?[]:{}:"array"===this.$type?Object.values(this.$_items).filter((e=>void 0!==e)).map((e=>e.$value)):Object.fromEntries(Object.values(this.$_items).filter((e=>void 0!==e)).map((e=>[e.$name,e.$value])))}get $length(){return Object.entries(this.$_items).length}$convertToDataValue(){return new Q(this.$name,this.$value,this.$type,this.parent)}$addDataNode(e,t,n=!1){if(t!==W){if("array"===this.$type){const i=e;n?this.$_items[e]=t:this.$_items.splice(i,0,t)}else this.$_items[e]=t;t.parent=this}}$removeDataNode(e){"array"===this.$type?this.$_items.splice(e,1):this.$_items[e]=void 0}$getDataNode(e){if(this.$_items.hasOwnProperty(e))return this.$_items[e]}$containsDataNode(e){return this.$_items.hasOwnProperty(e)&&void 0!==this.$_items[e]}get $isDataGroup(){return!0}}const J="Identifier",K="Global",Z="Repeatable",H="bracket",X=(e,t)=>({type:J,value:e,start:t}),Y=function(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"||e>="0"&&e<="9"||"_"===e},ee=(e,t,n)=>null===e&&"$"===t[n],te=(e,t,n)=>null===e&&"#"===t[n],ne=(e,t)=>{const n=e[t];return"$"===n?e.length>t&&Y(e[t+1]):n>="a"&&n<="z"||n>="A"&&n<="Z"||"_"===n},ie=e=>e>="0"&&e<="9";class se{stream;_current;_tokens=[];_result_tokens=[];constructor(e){this.stream=e,this._current=0}_consumeGlobal(){return this._current+=1,{type:K,start:0,value:"$"}}_consumeRepeatable(){return this._current+=1,{type:Z,start:0,value:"#"}}_consumeUnquotedIdentifier(e){const t=this._current;for(this._current+=1;this._current<e.length&&Y(e[this._current]);)this._current+=1;return X(e.slice(t,this._current),t)}_consumeQuotedIdentifier(e){const t=this._current;this._current+=1;const n=e.length;for(;'"'!==e[this._current]&&this._current<n;){let t=this._current;"\\"!==e[t]||"\\"!==e[t+1]&&'"'!==e[t+1]?t+=1:t+=2,this._current=t}return this._current+=1,X(JSON.parse(e.slice(t,this._current)),t)}_consumeNumber(e){const t=this._current;this._current+=1;const n=e.length;for(;ie(e[this._current])&&this._current<n;)this._current+=1;const i=e.slice(t,this._current);return{type:"Number",value:parseInt(i,10),start:t}}_consumeBracket(e){const t=this._current;let n;if(this._current+=1,!ie(e[this._current]))throw new Error(`unexpected exception at position ${this._current}. Must be a character`);if(n=this._consumeNumber(e).value,this._current<this.stream.length&&"]"!==e[this._current])throw new Error(`unexpected exception at position ${this._current}. Must be a character`);return this._current++,((e,t)=>({type:H,value:e,start:t}))(n,t)}tokenize(){const e=this.stream;for(;this._current<e.length;){const t=this._tokens.length?this._tokens.slice(-1)[0]:null;if(ee(t,e,this._current)){const e=this._consumeGlobal();this._tokens.push(e),this._result_tokens.push(e)}else if(te(t,e,this._current)){const e=this._consumeRepeatable();this._tokens.push(e),this._result_tokens.push(e)}else if(ne(e,this._current)){const t=this._consumeUnquotedIdentifier(e);this._tokens.push(t),this._result_tokens.push(t)}else if("."===e[this._current]&&null!=t&&"DOT"!==t.type)this._tokens.push({type:"DOT",value:".",start:this._current}),this._current+=1;else if("["===e[this._current]){const t=this._consumeBracket(e);this._tokens.push(t),this._result_tokens.push(t)}else{if('"'!==e[this._current]){const e=Math.max(0,this._current-2),t=Math.min(this.stream.length,this._current+2);throw new Error(`Exception at parsing stream ${this.stream.slice(e,t)}`)}{const t=this._consumeQuotedIdentifier(e);this._tokens.push(t),this._result_tokens.push(t)}}}return this._result_tokens}}const re=e=>new se(e).tokenize(),ae=(e,t,n)=>{let i;i="string"==typeof t?re(t):t;let s=e,r=0;const a=(e,t,n)=>null===t?n:t.type===H?new G(e.value,[],"array"):new G(e.value,{});for(;r<i.length&&null!=s;){const t=i[r];if(t.type===K)s=e;else if(t.type===J){if(!(s instanceof G&&"object"===s.$type))throw new Error(`Looking for ${t.value} in ${s.$value}`);if(s.$containsDataNode(t.value)&&null!==s.$getDataNode(t.value).$value)s=s.$getDataNode(t.value);else if(n){const e=a(t,r<i.length-1?i[r+1]:null,n);s.$addDataNode(t.value,e),s=e}else s=void 0}else if(t.type===H){if(!(s instanceof G&&"array"===s.$type))throw new Error(`Looking for index ${t.value} in non array${s.$value}`);{const e=t.value;if(e<s.$length)s=s.$getDataNode(e);else if(n){const o=a(t,r<i.length-1?i[r+1]:null,n);s.$addDataNode(e,o),s=o}else s=void 0}}r+=1}return s};class oe{data;mediaType="application/octet-stream";name="unknown";size=0;constructor(e){Object.assign(this,e)}get type(){return this.mediaType}set type(e){this.mediaType=e}toJSON(){return{name:this.name,size:this.size,mediaType:this.mediaType,data:this.data.toString()}}equals(e){return this.data===e.data&&this.mediaType===e.mediaType&&this.name===e.name&&this.size===e.size}}const le="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_".split(""),ue=/^(\d*\.?\d+)(\\?(?=[KMGT])([KMGT])(?:i?B)?|B?)$/i,de=e=>{const t=[];for(let n=0;n<=e;n++){let e;e=0===n?Math.floor(Math.random()*(le.length-11)):Math.floor(Math.random()*le.length),t.push(le[e])}return t.join("")},he=(e,t=!1)=>{const n=e.items||[];return n?.reduce(((e,n)=>{if(t&&null===n.dataRef)return e;let i=null;if(n.isContainer)i=he(n,t);else if(V(n.getState())){i={};const e=n.name||"",t=null!=n.dataRef?n.dataRef:e.length>0?n.name:void 0;n.value instanceof Array?i[n.id]=n.value.map((e=>({...e,dataRef:t}))):null!=n.value&&(i[n.id]={...n.value,dataRef:t})}return Object.assign(e,i)}),{})},ce=e=>{let t=0;if("string"==typeof e){const n=ue.exec(e.trim());null!=n&&(t=pe(parseFloat(n[1]),(n[2]||"kb").toUpperCase()))}return t},pe=(e,t)=>{const n=Math.pow(1024,{KB:1,MB:2,GB:3,TB:4}[t]);return Math.round(e*n)},me=e=>null!=/^data:([a-z]+\/[a-z0-9-+.]+)?;(?:name=(.*);)?base64,(.*)$/.exec(e.trim()),fe=e=>{const t=/^data:([a-z]+\/[a-z0-9-+.]+)?(?:;name=([^;]+))?(;base64)?,(.+)$/.exec(e);if(null!==t){const e=t[1]||"",n=t[2]||"unknown";if("string"==typeof t[3]){const i=atob(t[4]),s=[];for(let e=0;e<i.length;e++)s.push(i.charCodeAt(e));return{name:n,blob:new window.Blob([new Uint8Array(s)],{type:e})}}return{name:n,blob:new window.Blob([t[4]],{type:e})}}return null},ge=e=>{if(!e||!Object.keys(e).length)return e;if((":items"in(t=e)||"cqItems"in t)&&(":itemsOrder"in t||"cqItemsOrder"in t)){const t=[],n=e[":itemsOrder"]||e.cqItemsOrder,i=e[":items"]||e.cqItems;n.forEach((e=>{t.push(ge(i[e]))})),e.items=t}var t;return e},_e=/^(\d{4})-(\d{1,2})-(\d{1,2})$/,ye=/^[a-zA-Z0-9.!#$%&’*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/,ve=[31,28,31,30,31,30,31,31,30,31,30,31],be=e=>{if(""===e||null==e)return{value:"",valid:!0};let t=parseFloat(e);const n=!isNaN(t);return n||(t=e),{value:t,valid:n}},Me=e=>{if(""===e||null==e)return{value:"",valid:!0};let t=parseFloat(e);const n=!isNaN(t)&&Math.round(t)===t;return n||(t=e),{value:t,valid:n}},je=e=>null==e||e instanceof Array?e:[e],xe=e=>{const t="boolean"==typeof e||"true"===e||"false"===e;return{valid:t,value:"boolean"==typeof e?e:t?"true"===e:e}},Ee=e=>{const t=(e=>{if(null!==e){let t=null;if(e instanceof oe)t=e;else if("undefined"!=typeof File&&e instanceof File)t={name:e.name,mediaType:e.type,size:e.size,data:e};else if("string"==typeof e&&me(e)){const n=fe(e);if(null!==n){const{blob:e,name:i}=n;t={name:i,mediaType:e.type,size:e.size,data:e}}}else{let n=e;try{n=JSON.parse(e),t=n,t.mediaType||(t.mediaType=t.type)}catch(e){}if("string"==typeof n?.data&&me(n?.data)){const e=fe(n?.data);if(null!==e){const i=e.blob;t={name:n?.name,mediaType:n?.type||n?.mediaType,size:i.size,data:i}}}else"string"==typeof n?t={name:n.split("/").pop(),mediaType:"application/octet-stream",size:0,data:n}:"object"==typeof n&&(t={name:n?.name,mediaType:n?.type||n?.mediaType,size:n?.size,data:n?.data})}return null!==t&&null!=t.data?new oe(t):null}return null})(e),n=null!==t;return{value:n?t:e,valid:n}},we=(e,t)=>{const n=je(e);return null==n?[[],[n]]:n.reduce(((e,n)=>{if(0==e[1].length){const i=t(n);e[i.valid?0:1].push(i.value)}return e}),[[],[]])},De={date:["minimum","maximum","exclusiveMinimum","exclusiveMaximum","format"],string:["minLength","maxLength","pattern"],number:["minimum","maximum","exclusiveMinimum","exclusiveMaximum"],array:["minItems","maxItems","uniqueItems"],file:["accept","maxFileSize"],email:["minLength","maxLength","format","pattern"]},$e=["type","format","minimum","maximum","exclusiveMinimum","exclusiveMaximum","minItems","maxItems","uniqueItems","minLength","maxLength","pattern","required","enum","accept","maxFileSize"],Te={type:(e,t)=>{let n=t;if(null==t)return{valid:!0,value:t};let i,s=!0;switch(e){case"string":s=!0,n=t.toString();break;case"string[]":n=je(t);break;case"number":i=be(t),n=i.value,s=i.valid;break;case"boolean":i=xe(t),s=i.valid,n=i.value;break;case"integer":i=Me(t),s=i.valid,n=i.value;break;case"integer[]":i=we(t,Me),s=0===i[1].length,n=s?i[0]:t;break;case"file":i=Ee(t instanceof Array?t[0]:t),s=i.valid,n=i.value;break;case"file[]":i=we(t,Ee),s=0===i[1].length,n=s?i[0]:t;break;case"number[]":i=we(t,be),s=0===i[1].length,n=s?i[0]:t;break;case"boolean[]":i=we(t,xe),s=0===i[1].length,n=s?i[0]:t}return{valid:s,value:n}},format:(e,t)=>{let n=!0;const i=t;if(null===t)return{value:i,valid:n};let s;switch(e){case"date":if(s=_e.exec((t||"").trim()),null!=s){const[e,t,i,r]=s,[a,o]=[+i,+r],l=(e=>e%400==0||e%4==0&&e%100!=0)(+t);n=a>=1&&a<=12&&o>=1&&o<=((e,t)=>e&&2==t?29:ve[t-1])(l,a)}else n=!1;break;case"email":n=new RegExp(ye).test((t||"").trim());break;case"data-url":n=!0}return{valid:n,value:i}},minimum:(e,t)=>({valid:t>=e,value:t}),maximum:(e,t)=>({valid:t<=e,value:t}),exclusiveMinimum:(e,t)=>({valid:t>e,value:t}),exclusiveMaximum:(e,t)=>({valid:t<e,value:t}),minItems:(e,t)=>({valid:t instanceof Array&&t.length>=e,value:t}),maxItems:(e,t)=>({valid:t instanceof Array&&t.length<=e,value:t}),uniqueItems:(e,t)=>({valid:!e||t instanceof Array&&t.length===new Set(t).size,value:t}),minLength:(e,t)=>({...Te.minimum(e,"string"==typeof t?t.length:0),value:t}),maxLength:(e,t)=>({...Te.maximum(e,"string"==typeof t?t.length:0),value:t}),pattern:(e,t)=>{let n;return n="string"==typeof e?new RegExp(e):e,{valid:n.test(t),value:t}},required:(e,t)=>({valid:!e||null!=t&&""!==t,value:t}),enum:(e,t)=>({valid:e.indexOf(t)>-1,value:t}),accept:(e,t)=>{if(!e||0===e.length||null==t)return{valid:!0,value:t};return{valid:!(t instanceof Array?t:[t]).some((t=>{return n=t.type,i=e,!(!n||i.some((e=>{const t=e.trim(),i=t.split("/")[0],s=t.split(".")[1];return t.includes("*")&&n.startsWith(i)||t.includes(".")&&n.endsWith(s)||t===n})));var n,i})),value:t}},maxFileSize:(e,t)=>{const n="string"==typeof e?ce(e):e;return{valid:!(t instanceof oe)||t.size<=n,value:t}}},Ne=["value","label","description","visible","enabled","valid","errorMessage","readOnly","enum","enumNames","required","properties","exclusiveMinimum","exclusiveMaximum","maximum","maxItems","minimum","minItems","checked"],Ie=[...Ne,"index","activeChild"],Oe=["plain-text","image"];class Fe{_action;_target;_currentTarget;constructor(e,t){this._action=e,e.target?(this._currentTarget=t,this._target=e.target):(this._target=t,this._currentTarget=t)}get type(){return this._action.type}get payload(){return this._action.payload}get metadata(){return this._action.metadata}get target(){return this._target}get currentTarget(){return this._currentTarget}get isCustomEvent(){return this._action.isCustomEvent}get originalAction(){return this._action.originalAction}toString(){return this._action.toString()}}const ke=Symbol("target"),Ce=Symbol("qualifiedName");const Se=e=>(...t)=>(n,i,s)=>{const r=s.get;null!=r&&(s.get=function(){if(t.indexOf(this.fieldType)>-1===e)return r.call(this)});const a=s.set;null!=a&&(s.set=function(n){t.indexOf(this.fieldType)>-1===e&&a.call(this,n)})},Re=Se(!0),Ae=Se(!1);class Pe{_options;_ruleNode;_lang="";_callbacks={};_dependents=[];_jsonModel;_tokens=[];_eventSource=e.CODE;get isContainer(){return!1}constructor(e,t){this._options=t,this[Ce]=null,this._jsonModel={...e,id:"id"in e?e.id:this.form.getUniqueId()}}setupRuleNode(){const e=this;this._ruleNode=new Proxy(this.ruleNodeReference(),{get:(t,n)=>e.getFromRule(t,n)})}ruleNodeReference(){return this}getRuleNode(){return this._ruleNode}getFromRule(e,t){if(t===Symbol.toPrimitive||"valueOf"===t&&!e.hasOwnProperty("valueOf"))return this.valueOf;if(t===ke)return this;if("string"==typeof t)if(t.startsWith("$")){if("function"!=typeof this[t=t.substr(1)]){const e=this[t];return e instanceof Pe?e.getRuleNode():e instanceof Array?e.map((e=>e instanceof Pe?e.getRuleNode():e)):e}}else{if(e.hasOwnProperty(t))return e[t];if("function"==typeof e[t])return e[t]}}get id(){return this._jsonModel.id}get index(){return this.parent?this.parent.indexOf(this):0}get parent(){return this._options.parent}get type(){return this._jsonModel.type}get repeatable(){return this.parent?.hasDynamicItems()}get fieldType(){return this._jsonModel.fieldType||"text-input"}get":type"(){return this._jsonModel[":type"]||this.fieldType}get name(){return this._jsonModel.name}get description(){return this._jsonModel.description}set description(e){this._setProperty("description",e)}get dataRef(){return this._jsonModel.dataRef}get visible(){return void 0!==this.parent?.visible?!!this.parent?.visible&&this._jsonModel.visible:this._jsonModel.visible}set visible(e){if(e!==this._jsonModel.visible){const n=t("visible",e,this._jsonModel.visible);this._jsonModel.visible=e,this.notifyDependents(n)}}get form(){return this._options.form}get ruleEngine(){return this.form.ruleEngine}get label(){return this._jsonModel.label}set label(e){if(e!==this._jsonModel.label){const n=t("label",e,this._jsonModel.label);this._jsonModel={...this._jsonModel,label:e},this.notifyDependents(n)}}get uniqueItems(){return this._jsonModel.uniqueItems}isTransparent(){const e="array"===this.parent?._jsonModel?.type;return!this._jsonModel.name&&!e}getDependents(){return this._dependents.map((e=>e.node.id))}getState(e=!1){return{...this._jsonModel,properties:this.properties,index:this.index,parent:void 0,qualifiedName:this.qualifiedName,...!0===this.repeatable?{repeatable:!0,minOccur:this.parent.minItems,maxOccur:this.parent.maxItems}:{},":type":this[":type"],...e?{_dependents:this._dependents.length?this.getDependents():void 0,allowedComponents:void 0,columnClassNames:void 0,columnCount:void 0,gridClassNames:void 0}:{}}}subscribe(e,t="change"){return this._callbacks[t]=this._callbacks[t]||[],this._callbacks[t].push(e),{unsubscribe:()=>{this._callbacks[t]=this._callbacks[t].filter((t=>t!==e))}}}_addDependent(e){if(void 0===this._dependents.find((({node:t})=>t===e))){const t=this.subscribe((t=>{const i=t.payload.changes,s=[...Ie,"items"];i.findIndex((e=>s.indexOf(e.propertyName)>-1))>-1&&("deps"===this.form.changeEventBehaviour?e.dispatch(t):e.dispatch(new n))}));this._dependents.push({node:e,subscription:t})}}removeDependent(e){const t=this._dependents.findIndex((({node:t})=>t===e));t>-1&&(this._dependents[t].subscription.unsubscribe(),this._dependents.splice(t,1))}queueEvent(e){const t=new Fe(e,this);this.form.getEventQueue().queue(this,t,["valid","invalid"].indexOf(t.type)>-1)}dispatch(e){this.queueEvent(e),this.form.getEventQueue().runPendingQueue()}notifyDependents(e){const t=this._jsonModel._dependents;t&&(t.forEach((e=>{const t=this.form.getElement(e);t&&this._addDependent(t)})),this._jsonModel._dependents=void 0);(this._callbacks[e.type]||[]).forEach((t=>{t(new Fe(e,this))}))}isEmpty(e=this._jsonModel.value){return null==e||""===e}_setProperty(e,n,i=!0,s=(e=>{})){const r=this._jsonModel[e];let a=!1;if(a=null!==n&&null!==r&&"object"==typeof n&&"object"==typeof r?JSON.stringify(n)===JSON.stringify(r):r===n,!a){this._jsonModel[e]=n;const a=t(e,n,r);return i&&this.notifyDependents(a),s.call(this,a),$e.includes(e)&&this.validate(),a.payload.changes}return[]}_bindToDataModel(e){if("form"===this.fieldType||"$form"===this.id)return void(this._data=e);const t=this._jsonModel.dataRef;let n,i=e,s="";if(null===t)n=W;else if(void 0===t||this.repeatable){if(e!==W&&-1===Oe.indexOf(this.fieldType)){i=e;const t=this._jsonModel.name||"",r="array"===e.$type?this.index:t;if(s=r,""!==r){const t=this.defaultDataModel(r);void 0!==t&&(n=e.$getDataNode(r),void 0===n&&(n=t,e.$addDataNode(r,n)))}else n=void 0}}else{0===this._tokens.length&&(this._tokens=re(t));let r=e;if(this._tokens[0].type===K)r=this.form.getDataNode();else if(this._tokens[0].type===Z){let e=this.parent;for(;!e.repeatable&&e!==this.form;)e=e.parent;r=e.getDataNode()}if(void 0!==r){const e=this._tokens[this._tokens.length-1].value,t=this.defaultDataModel(e);n=ae(r,this._tokens,t),i=ae(r,this._tokens.slice(0,-1)),s=e}}n&&(this.isContainer||i===W||n===W||(n=n?.$convertToDataValue(),i.$addDataNode(s,n,!0)),n?.$bindToField(this),this._data=n)}_data;getDataNode(){return this._data}get lang(){return this._jsonModel.lang&&(this._lang=this._jsonModel.lang),this._lang||(this.parent?this._lang=this.parent.lang:this._lang=Intl.DateTimeFormat().resolvedOptions().locale),this._lang}get properties(){return this._jsonModel.properties||{}}set properties(e){this._setProperty("properties",{...e})}getNonTransparentParent(){let e=this.parent;for(;null!=e&&e.isTransparent();)e=e.parent;return e}_initialize(e){if(void 0===this._data){let e,t=this.parent;do{e=t.getDataNode(),t=t.parent}while(void 0===e);this._bindToDataModel(e)}}_applyUpdates(e,t){return e.reduce(((e,n)=>{const i=t[n],s=this._setProperty(n,i,!1);return s.length>0&&(e[n]=s[0]),e}),{})}get qualifiedName(){if(this.isTransparent())return null;if(null!==this[Ce])return this[Ce];const e=this.getNonTransparentParent();return e&&"array"===e.type?this[Ce]=`${e.qualifiedName}[${this.index}]`:this[Ce]=`${e.qualifiedName}.${this.name}`,this[Ce]}focus(){this.parent&&(this.parent.activeChild=this)}_getDefaults(){return{}}_applyDefaultsInModel(){Object.entries(this._getDefaults()).map((([e,t])=>{void 0===this._jsonModel[e]&&void 0!==t?this._jsonModel[e]=t:"object"!=typeof t||null===t||Array.isArray(t)||Object.keys(t).forEach((n=>{void 0===this._jsonModel[e][n]&&(this._jsonModel[e][n]=t[n])}))}))}}C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],Pe.prototype,"index",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],Pe.prototype,"description",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],Pe.prototype,"visible",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],Pe.prototype,"label",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],Pe.prototype,"properties",null);class qe extends Pe{_events={};_rules={};getRules(){return"object"!=typeof this._jsonModel.rules?{}:this._jsonModel.rules}getCompiledRule(e,t){if(!(e in this._rules)){const n=t||this.getRules()[e];if(!("string"==typeof n&&n.length>0))throw new Error(`only expression strings are supported. ${typeof n} types are not supported`);try{this._rules[e]=this.ruleEngine.compileRule(n,this.lang)}catch(t){this.form.logger.error(`Unable to compile rule \`"${e}" : "${n}"\` Exception : ${t}`)}}return this._rules[e]}getCompiledEvent(e){if(!(e in this._events)){let t=this._jsonModel.events?.[e];"string"==typeof t&&t.length>0&&(t=[t]),void 0!==t&&t.length>0&&(this._events[e]=t.map((n=>{try{return this.ruleEngine.compileRule(n,this.lang)}catch(n){this.form.logger.error(`Unable to compile expression \`"${e}" : "${t}"\` Exception : ${n}`)}return null})).filter((e=>null!==e)))}return this._events[e]||[]}applyUpdates(e){"object"==typeof e?null!==e&&Object.entries(e).forEach((([e,t])=>{if(e in Ne||e in this&&"function"!=typeof this[e])try{this[e]=t}catch(e){console.error(e)}})):void 0!==e&&(this.value=e)}executeAllRules(e){const t=Object.entries(this.getRules());if(t.length>0){const n=this.getExpressionScope();t.forEach((([t,i])=>{const s=this.getCompiledRule(t,i);if(s){const i=this.ruleEngine.execute(s,n,e,!0);if(Ne.indexOf(t)>-1){this.isEmpty()&&this.isEmpty(i)&&"value"===t||(this[t]=i)}else this.form.logger.warn(`${t} is not a valid editable property.`)}}))}}getExpressionScope(){const e=this.getNonTransparentParent(),t={self:this.getRuleNode(),siblings:e?.ruleNodeReference()||{}},n=new Proxy(t,{get:(e,t)=>{if(t===Symbol.toStringTag)return"Object";if("string"==typeof t&&t.startsWith("$")){const n=e.self[t];return n instanceof Pe?n.getRuleNode():n instanceof Array?n.map((e=>e instanceof Pe?e.getRuleNode():e)):n}return t in e.siblings?e.siblings[t]:e.self[t]},has:(e,t)=>{const n=e.self[t],i=e.siblings[t];return void 0!==n||void 0!==i}});return n}executeEvent(e,t){let n;t&&(n=this.ruleEngine.execute(t,this.getExpressionScope(),e)),void 0!==n&&null!=n&&this.applyUpdates(n)}executeRule(e,t){void 0===e.payload.ruleName&&this.executeAllRules(t)}executeExpression(e){const t={form:this.form,$form:this.form.getRuleNode(),$field:this.getRuleNode(),field:this},n=this.ruleEngine.compileRule(e,this.lang);return this.ruleEngine.execute(n,this.getExpressionScope(),t)}change(e,t){"deps"===this.form.changeEventBehaviour&&this.executeAllRules(t)}executeAction(e){const t={form:this.form,$form:this.form.getRuleNode(),$field:this.getRuleNode(),field:this,$event:{type:e.type,payload:e.payload,target:this.getRuleNode()}},n=e.isCustomEvent?`custom:${e.type}`:e.type,i=e.isCustomEvent?`custom_${e.type}`:e.type,s=this.getCompiledEvent(n);i in this&&"function"==typeof this[i]&&this[i](e,t),s.forEach((e=>this.executeEvent(t,e))),e.target===this&&this.notifyDependents(e)}}const Ve=["readOnly","enabled"];class ze extends qe{_children=[];_childrenReference;_itemTemplate=null;fieldFactory;constructor(e,t){super(e,{form:t.form,parent:t.parent,mode:t.mode}),this.fieldFactory=t.fieldFactory}_getDefaults(){return{...super._getDefaults(),enabled:!0,readOnly:!1}}ruleNodeReference(){return this._childrenReference}get items(){return this._children}get maxItems(){return this._jsonModel.maxItems}set maxItems(e){this._jsonModel.maxItems=e;const n=this._jsonModel.minItems||1,i=this._children.length,s=Math.min(i-e,i-n);if(s>0){for(let t=0;t<s;t++)this.getDataNode().$removeDataNode(e+t),this._childrenReference.pop();const n=this._children.splice(e,s);this.notifyDependents(t("items",n,null))}}get minItems(){return this._jsonModel.minItems}set minItems(e){this._jsonModel.minItems=e;const n=this._children.length-e,i=Math.abs(n);if(n<0){const e=[];for(let t=0;t<i;t++)e.push(this._addChild(this._itemTemplate,null,!0));this.notifyDependents(t("items",e,null))}}hasDynamicItems(){return null!=this._itemTemplate}get isContainer(){return!0}_activeChild=null;isSiteContainer(e){return(":items"in e||"cqItems"in e)&&!("fieldType"in e)}isAFormField(e){return"fieldType"in e||"id"in e||"name"in e||"dataRef"in e||"type"in e}_getFormAndSitesState(e=!1,t=!1){return this._jsonModel.items?this._jsonModel.items.map((n=>{if(this.isSiteContainer(n)){const e={...n?.id?{id:this.form.getUniqueId()}:{}};return{...n,...e,":items":this.walkSiteContainerItems(n)}}return this.isAFormField(n)?{...this.form.getElement(n?.id).getState(e,t)}:n})):[]}getItemsState(e=!1,t=!1){return"array"===this._jsonModel.type||L(this._jsonModel)||e?e?this._getFormAndSitesState(e,t):this._children.map((e=>({...e.getState(!0,t)}))):this._getFormAndSitesState(e,t)}getState(e=!1,t=!1){return{...super.getState(t),...t?{":items":void 0,":itemsOrder":void 0}:{},items:this.getItemsState(e,t),enabled:this.enabled,readOnly:this.readOnly}}_createChild(e,t){return this.fieldFactory.createField(e,t)}walkSiteContainerItems(e){return Object.fromEntries(Object.entries(e[":items"]).map((([e,t])=>{if(this.isAFormField(t))return[e,this.form.getElement(t?.id).getState()];if(this.isSiteContainer(t))return this.walkSiteContainerItems(t);if("object"==typeof t){const n={...t?.id?{id:this.form.getUniqueId()}:{}};return[e,{...t,...n}]}return[e,t]})))}_addChildToRuleNode(e,t){const n=this,{parent:i=this}=t,s="array"==i.type?i._children.length+"":e.name||"";s.length>0&&Object.defineProperty(i._childrenReference,s,{get:()=>(e.isContainer&&e.hasDynamicItems()&&n.ruleEngine.trackDependency(e),n.hasDynamicItems()?(n.ruleEngine.trackDependency(n),void 0!==this._children[s]?this._children[s].getRuleNode():void 0):e.getRuleNode()),configurable:!0,enumerable:!0})}_addChild(e,t,n=!1,i="create"){let s=this;for(;null!=s&&s.isTransparent();)s=s.parent;("number"!=typeof t||t>s._children.length)&&(t=this._children.length);const r=this.form,a={index:t,...z(e,n?()=>r.getUniqueId():void 0)},o=this._createChild(a,{parent:this,form:this.form,mode:i});return e.id=o.id,this.form.fieldAdded(o),this._addChildToRuleNode(o,{parent:s}),t===this._children.length?this._children.push(o):this._children.splice(t,0,o),o}indexOf(e){return this._children.indexOf(e)}defaultDataModel(e){const t=this._jsonModel.type||void 0;if(void 0!==t){return new G(e,"array"===t?[]:{},t)}}_canHaveRepeatingChildren(e="create"){const t=this._jsonModel.items;return"array"==this._jsonModel.type&&null!=this.getDataNode()&&(1===t.length||1==t[0].repeatable&&"restore"===e)}_initialize(e){super._initialize(e);const t=this._jsonModel.items||[];if(this._childrenReference="array"==this._jsonModel.type?[]:{},this._canHaveRepeatingChildren(e)){this._itemTemplate=z(t[0]),"restore"===e&&(this._itemTemplate.repeatable=void 0),"number"!=typeof this._jsonModel.minItems&&(this._jsonModel.minItems=0),"number"!=typeof this._jsonModel.maxItems&&(this._jsonModel.maxItems=-1),"number"!=typeof this._jsonModel.initialItems&&(this._jsonModel.initialItems=Math.max(1,this._jsonModel.minItems));for(let n=0;n<this._jsonModel.initialItems;n++){let i;if("restore"===e){let s=this._itemTemplate;n<this._jsonModel.items.length&&(s=z(t[n]),s.repeatable=void 0),i=this._addChild(s,void 0,n>this._jsonModel.items.length-1,e)}else i=this._addChild(this._itemTemplate,void 0,n>this._jsonModel.items.length-1);"create"===e&&(t[0].id=i.id),i._initialize(e)}}else t.length>0?(t.forEach((t=>{if(this.isSiteContainer(t))this._initializeSiteContainer(t);else if(this.isAFormField(t)){this._addChild(t,void 0,!1,e)._initialize(e)}else this.form.logger.warn(`A container item was not initialized. ${t}`)})),this._jsonModel.minItems=this._children.length,this._jsonModel.maxItems=this._children.length,this._jsonModel.initialItems=this._children.length):this.form.logger.warn("A container exists with no items.");this.setupRuleNode()}_initializeSiteContainer(e){Object.entries(e[":items"]).forEach((([e,t])=>{if(this.isAFormField(t)){this._addChild(t)._initialize()}else if(this.isSiteContainer(t))return this._initializeSiteContainer(t)}))}addItem(e){if(("addItem"===e.type||"addInstance"==e.type)&&null!=this._itemTemplate&&(-1===this._jsonModel.maxItems||this._children.length<this._jsonModel.maxItems)){const s=this.getDataNode();let r=e.payload;const a=this._addChild(this._itemTemplate,e.payload,!0);("number"!=typeof r||r>this._children.length)&&(r=this._children.length);const o=a.defaultDataModel(r);o&&s.$addDataNode(r,o),a._initialize("create"),this.notifyDependents(t("items",a.getState(),null)),a.dispatch(new i),a.dispatch(new n);for(let e=r+1;e<this._children.length;e++)this._children[e].dispatch(new n)}}removeItem(e){if(("removeItem"===e.type||"removeInstance"==e.type)&&null!=this._itemTemplate){if(0==this._children.length)return;let i=e.payload;"number"!=typeof i&&(i=this._children.length-1);const s=this._children[i].getState();if(this._children.length>this._jsonModel.minItems){this._childrenReference.pop(),this._children.splice(i,1),this.getDataNode().$removeDataNode(i);for(let e=i;e<this._children.length;e++)this._children[e].dispatch(new n);this.notifyDependents(t("items",null,s))}}}queueEvent(e){super.queueEvent(e),e.metadata?.dispatch&&this.items.forEach((t=>{t.queueEvent(e)}))}reset(){if(("array"===this.type||L(this._jsonModel))&&this.items.length>this._jsonModel.initialItems){const e=this.items.length-this._jsonModel.initialItems;for(let t=0;t<e;t++)this.dispatch(new s)}this.items.forEach((e=>{e.reset()}))}validate(){return this.items.flatMap((e=>e.validate())).filter((e=>""!==e.fieldName))}dispatch(e){super.dispatch(e)}importData(e){this._bindToDataModel(e);const t=this.getDataNode()||e;this.syncDataAndFormModel(t)}syncDataAndFormModel(e){const t={added:[],removed:[]};if("array"===e?.$type&&null!=this._itemTemplate){const n=e?.$value.length,i=this._children.length,s=-1===this._jsonModel.maxItems?n:this._jsonModel.maxItems,r=this._jsonModel.minItems;let a=Math.min(n-i,s-i);const o=Math.min(i-n,i-r);for(;a>0;){a--;const e=this._addChild(this._itemTemplate);e._initialize("create"),t.added.push(e)}if(o>0){this._children.splice(n,o);for(let e=0;e<o;e++)t.removed.push(this._childrenReference.pop())}}return this._children.forEach((t=>{t.importData(e)})),t}get activeChild(){return this._activeChild}set activeChild(e){if(e!==this._activeChild){let n=this._activeChild;for(;n instanceof ze;){const e=n.activeChild;n.activeChild=null,n=e}const i=t("activeChild",e,this._activeChild);this._activeChild=e,this.parent&&null!==e&&(this.parent.activeChild=this),this._jsonModel.activeChild=e?.id,this.notifyDependents(i)}}get enabled(){return void 0!==this.parent?.enabled?!!this.parent?.enabled&&this._jsonModel.enabled:this._jsonModel.enabled}set enabled(e){this._setProperty("enabled",e,!0,this.notifyChildren)}get readOnly(){return void 0!==this.parent?.readOnly&&!!this.parent.readOnly||this._jsonModel.readOnly}set readOnly(e){this._setProperty("readOnly",e,!0,this.notifyChildren)}notifyChildren(e){if(void 0!==e.payload&&void 0!==e.payload.changes)for(const n of e.payload.changes)void 0!==n.propertyName&&Ve.includes(n.propertyName)&&this.items.forEach((i=>{this.notifyDependents.call(i,t(n.propertyName,i.getState()[n.propertyName],null)),"panel"===i.fieldType&&this.notifyChildren.call(i,e)}))}}C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],ze.prototype,"maxItems",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],ze.prototype,"minItems",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],ze.prototype,"activeChild",null);class Ue{_jsonModel;constructor(e){this._jsonModel={...e}}getP(e,t){return((e,t,n)=>{if(t in e)return e[t];if(!t.startsWith(":")){const n=`:${t}`;if(n in e)return e[n]}return n})(this._jsonModel,e,t)}get isContainer(){return!1}}class Le extends Ue{get version(){return this.getP("version","")}get grammar(){return this.getP("grammar","")}}class Qe{lang;captchaInfo;constructor(e={}){this.lang=e.lang||"en",this.captchaInfo=e.captchaInfo||{},Object.keys(e).forEach((t=>{"lang"!==t&&"captchaInfo"!==t&&(this[t]=e[t])}))}}const Be={off:0,debug:1,info:2,warn:3,error:4};class We{debug(e){this.log(e,"debug")}info(e){this.log(e,"info")}warn(e){this.log(e,"warn")}error(e){this.log(e,"error")}log(e,t){0!==this.logLevel&&this.logLevel<=Be[t]&&console[t](e)}logLevel;constructor(e="off"){this.logLevel=Be[e]}}class Ge{_node;_event;constructor(e,t){this._node=e,this._event=t}get node(){return this._node}get event(){return this._event}isEqual(e){return null!=e&&this._node==e._node&&this._event.type==e._event.type}toString(){return this._node.id+"__"+this.event.type}valueOf(){return this.toString()}}class Je{logger;static MAX_EVENT_CYCLE_COUNT=10;_runningEventCount;_isProcessing=!1;_pendingEvents=[];constructor(e=new We("off")){this.logger=e,this._runningEventCount={}}get length(){return this._pendingEvents.length}get isProcessing(){return this._isProcessing}isQueued(e,t){const n=new Ge(e,t);return void 0!==this._pendingEvents.find((e=>n.isEqual(e)))}queue(e,t,n=!1){e&&t&&(t instanceof Array||(t=[t]),t.forEach((t=>{const i=new Ge(e,t),s=this._runningEventCount[i.valueOf()]||0;if(s<Je.MAX_EVENT_CYCLE_COUNT){if(this.logger.info(`Queued event : ${t.type} node: ${e.id} - ${e.name}`),n){const e=this._isProcessing?1:0;this._pendingEvents.splice(e,0,i)}else this._pendingEvents.push(i);this._runningEventCount[i.valueOf()]=s+1}else this.logger.info(`Skipped queueing event : ${t.type} node: ${e.id} - ${e.name} with count=${s}`)})))}empty(){this._pendingEvents=[]}runPendingQueue(){if(!this._isProcessing){for(this._isProcessing=!0;this._pendingEvents.length>0;){const e=this._pendingEvents[0];this.logger.info(`Dequeued event : ${e.event.type} node: ${e.node.id} - ${e.node.name}`),e.node.executeAction(e.event),this._pendingEvents.shift()}this._runningEventCount={},this._isProcessing=!1}}}const Ke=(e,t=null,n={})=>{const i={...Ze,...n},s="GET"===i.method&&t?He(e,t):e;return"GET"!==i.method&&(i.body=t),fetch(s,{...i}).then((async t=>{let n;t.ok||console.error(`Error while fetching response from ${e} : ${t.statusText}`),n=t?.headers?.get("Content-Type")?.includes("application/json")?await t.json():await t.text();const i={};return t?.headers?.forEach(((e,t)=>{i[t]=e})),{status:t.status,body:n,headers:i}}))},Ze={method:"GET"},He=(e,t)=>{if(!t)return e;let n={};try{n=JSON.parse(t)}catch(e){console.log("Query params invalid")}const i=[];return Object.keys(n).forEach((e=>{Array.isArray(n[e])?i.push(`${encodeURIComponent(e)}=${encodeURIComponent(JSON.stringify(n[e]))}`):i.push(`${encodeURIComponent(e)}=${encodeURIComponent(n[e])}`)})),i.length?e.includes("?")?`${e}&${i.join("&")}`:`${e}?${i.join("&")}`:e},Xe=e=>{const t=e;return t.length>0&&t.startsWith("custom:")?t.substring(7):t},Ye=async(e,t,n,i,s,r,a)=>{const o=t,l={method:n};let u;if(i&&i instanceof oe&&i.data instanceof File){const e=new FormData;e.append(i.name,i.data),u=e}else if(i instanceof FormData)u=i;else if(i&&"object"==typeof i&&Object.keys(i).length>0){const e=Object.keys(a);e.length>0?l.headers={...a,...-1===e.indexOf("Content-Type")?{"Content-Type":"application/json"}:{}}:l.headers={"Content-Type":"application/json"};const t=l?.headers?.["Content-Type"]||"application/json";"application/json"===t?u=JSON.stringify(i):t.indexOf("multipart/form-data")>-1?u=tt(i):t.indexOf("application/x-www-form-urlencoded")>-1&&(u=et(i))}const d=await Ke(o,u,l);if(d?.status>=200&&d?.status<=299){const t=Xe(s);"submitSuccess"===s?e.form.dispatch(new f(d,!0)):e.form.dispatch(new g(t,d,!0))}else{e.form.logger.error("Error invoking a rest API");const t=Xe(r);"submitError"===r?(e.form.dispatch(new _(d,!0)),e.form.dispatch(new y(d,!0))):e.form.dispatch(new g(t,d,!0))}},et=e=>{const t=new URLSearchParams;return Object.entries(e).forEach((([e,n])=>{null!=n&&"object"==typeof n?t.append(e,U(n)):t.append(e,n)})),t},tt=(e,t)=>{const n=new FormData;Object.entries(e).forEach((([e,t])=>{null!=t&&"object"==typeof t?n.append(e,U(t)):n.append(e,t)}));const i=(e,t)=>{if(e?.data instanceof File){let n=`${e?.dataRef}/${e?.name}`;n.startsWith("/")||(n=`/${n}`),t.append(n,e.data)}};return t&&Object.keys(t).reduce(((e,s)=>{const r=t[s];return r&&r instanceof Array?[...e,...r.map((e=>i(e,n)))]:[...e,i(r,n)]}),[]),n},nt=(e,t={})=>{switch(e){case"change":return new r(t);case"submit":return new b(t);case"save":return new M(t);case"click":return new D(t);case"addItem":return new w(t);case"removeItem":return new s(t);case"reset":return new j(t);case"addInstance":return new E(t);case"removeInstance":return new x(t);default:console.error("invalid action")}};class it{static instance=null;customFunctions={};constructor(){}static getInstance(){return it.instance||(it.instance=new it),it.instance}registerFunctions(e){Object.entries(e).forEach((([e,t])=>{let n=t;"function"==typeof t&&(n={_func:(e,n,i)=>{const s={form:i.globals.$form,field:i.globals.$field,event:i.globals.$event,functions:{setProperty:(e,t)=>{const s=[e,"custom:setProperty",t];return it.getInstance().getFunctions().dispatchEvent._func.call(void 0,s,n,i)},reset:e=>{const t=[e=e||"reset","reset"];return i.globals.form.logger.warn("This usage of reset is deprecated. Please see the documentation and update."),it.getInstance().getFunctions().dispatchEvent._func.call(void 0,t,n,i)},validate:e=>{const t=[e];return it.getInstance().getFunctions().validate._func.call(void 0,t,n,i)},importData:e=>{const t=[e];return it.getInstance().getFunctions().importData._func.call(void 0,t,n,i)},exportData:()=>it.getInstance().getFunctions().exportData._func.call(void 0,e,n,i),submitForm:(e,t,s)=>{const r=[e,t,s||"multipart/form-data"];return it.getInstance().getFunctions().submitForm._func.call(void 0,r,n,i)},markFieldAsInvalid:(e,t,n)=>{!n||n.useId?i.globals.form.getElement(e)?.markAsInvalid(t):n&&n.useDataRef?i.globals.form.visit((function(n){n.dataRef===e&&n.markAsInvalid(t)})):n&&n.useQualifiedName&&i.globals.form.resolveQualifiedName(e)?.markAsInvalid(t)},setFocus:(e,t)=>{const s=[e,t];return it.getInstance().getFunctions().setFocus._func.call(void 0,s,n,i)},dispatchEvent:(e,t,s)=>{const r=[e,t,s];return it.getInstance().getFunctions().dispatchEvent._func.call(void 0,r,n,i)},getFiles:e=>{const t={};e||i.globals.form.visit((function(e){"file-input"===e.fieldType&&e.value&&(t[e.qualifiedName]=e.serialize())}));const n=i.globals.form.resolveQualifiedName(e);return"file-input"===n?.fieldType&&n?.value&&(t[e]=n.serialize()),t}}};return t(...e,s)},_signature:[]}),n.hasOwnProperty("_func")?it.getInstance().customFunctions[e]=n:console.warn(`Unable to register function with name ${e}.`)}))}unregisterFunctions(...e){e.forEach((e=>{e in it.getInstance().customFunctions&&delete it?.getInstance().customFunctions[e]}))}getFunctions(){function e(t){return null==t?t:null!==(n=t)&&"[object Array]"===Object.prototype.toString.call(n)?t.map((t=>e(t))):t.valueOf();var n}function t(e){return null==e?"":e.toString()}return{...{validate:{_func:(e,t,n)=>{const i=e[0];let s;return s="string"==typeof i||void 0===i?n.globals.form.validate():n.globals.form.getElement(i.$id).validate(),Array.isArray(s)&&s.length&&n.globals.form.logger.warn("Form Validation Error"),s},_signature:[]},setFocus:{_func:(e,t,n)=>{const i=e[0],s=e[1];try{const e=n.globals.form.getElement(i?.$id)||n.globals.field;n.globals.form.setFocus(e,s)}catch(e){n.globals.form.logger.error("An error has occurred within the setFocus API.")}},_signature:[]},getData:{_func:(e,t,n)=>(n.globals.form.logger.warn("The `getData` function is depricated. Use `exportData` instead."),n.globals.form.exportData()),_signature:[]},exportData:{_func:(e,t,n)=>n.globals.form.exportData(),_signature:[]},importData:{_func:(e,t,n)=>{const i=e[0];return"object"==typeof i&&null!==i&&n.globals.form.importData(i),{}},_signature:[]},submitForm:{_func:async(n,i,s)=>{let r,a,o,l=null,u=null;n.length>0&&"object"==typeof e(n[0])?(r=n.length>0?e(n[0]):null,a=!(n.length>1)||e(n[1]),o=n.length>2?t(n[2]):"multipart/form-data"):(s.globals.form.logger.warn("This usage of submitForm is deprecated. Please see the documentation and update"),l=t(n[0]),u=t(n[1]),o=n.length>2?t(n[2]):"multipart/form-data",r=n.length>3?e(n[3]):null,a=!(n.length>4)||e(n[4]));const d=s.globals.form;if(d.captcha&&(d.captcha.captchaDisplayMode===v.INVISIBLE||"enterprise"===d.captcha.properties["fd:captcha"]?.config?.version&&"score"===d.captcha.properties["fd:captcha"]?.config?.keyType)){if("function"!=typeof s.runtime.functionTable.fetchCaptchaToken?._func)return s.globals.form.logger.error("fetchCaptchaToken is not defined"),s.globals.form.dispatch(new _({type:"FetchCaptchaTokenNotDefined"})),{};try{const e=await s.runtime.functionTable.fetchCaptchaToken._func([],i,s);d.captcha.value=e}catch(e){return s.globals.form.logger.error("Error while fetching captcha token"),s.globals.form.dispatch(new _({type:"FetchCaptchaTokenFailed"})),{}}}return s.globals.form.dispatch(new b({success:l,error:u,submit_as:o,validate_form:a,data:r})),{}},_signature:[]},saveForm:{_func:(e,n,i)=>{const s=t(e[0]),r=e[2]||!1;return i.globals.form.dispatch(new M({action:s,validate_form:r})),{}},_signature:[]},request:{_func:(n,i,s)=>{const r=t(n[0]),a=t(n[1]),o=e(n[2]);let l,u,d={};return"string"==typeof n[3]?(s.globals.form.logger.warn("This usage of request is deprecated. Please see the documentation and update"),l=e(n[3]),u=e(n[4])):(d=e(n[3]),l=e(n[4]),u=e(n[5])),Ye(s.globals,r,a,o,l,u,d),{}},_signature:[]},addInstance:{_func:(t,n,i)=>{const s=t[0],r=t.length>2?e(t[2]):void 0;try{const e=i.globals.form.getElement(s.$id),t=nt("addInstance",r);e.addItem(t)}catch(e){i.globals.form.logger.error("Invalid argument passed in addInstance. An element is expected")}},_signature:[]},removeInstance:{_func:(t,n,i)=>{const s=t[0],r=t.length>2?e(t[2]):void 0;try{const e=i.globals.form.getElement(s.$id),t=nt("removeInstance",r);e.removeItem(t)}catch(e){i.globals.form.logger.error("Invalid argument passed in removeInstance. An element is expected")}},_signature:[]},dispatchEvent:{_func:(t,n,i)=>{const s=t[0];let r,a=e(t[1]),o=t.length>2?e(t[2]):void 0,l=!1;return"string"==typeof s&&(o=a,a=s,l=!0),r=a.startsWith("custom:")?new g(a.substring(7),o,l):nt(a,o),null!=r&&("string"==typeof s?i.globals.form.dispatch(r):i.globals.form.getElement(s.$id).dispatch(r)),{}},_signature:[]}},...it.getInstance().customFunctions}}}const st=it.getInstance();class rt{#e;#t;#n;#i=!0;constructor(e){const t=e.match(/([^.]+)\.([^.]+)(?:\.(.+))?/);if(!t)throw new Error("Invalid version string "+e);if(this.#t=+t[1],this.#e=+t[2],this.#n=t[3]?+t[3]:0,isNaN(this.#t)||isNaN(this.#e)||isNaN(this.#n))throw new Error("Invalid version string "+e)}get major(){return this.#t}get minor(){return this.#e}get subversion(){return this.#n}completeMatch(e){return this.major===e.major&&this.minor===e.minor&&this.#n===e.subversion}lessThan(e){return this.major<e.major||this.major===e.major&&this.minor<e.minor||this.major===e.major&&this.minor===e.minor&&this.#n<e.subversion}toString(){return`${this.major}.${this.minor}.${this.subversion}`}valueOf(){return this.toString()}}const at=new rt("0.13"),ot=new rt("0.13");class lt extends ze{_ruleEngine;_eventQueue;additionalSubmitMetadata={};_fields={};_ids;_invalidFields=[];_captcha=null;constructor(e,t,s,o=new Je,l="off",u="create"){super(e,{fieldFactory:t,mode:u}),this._ruleEngine=s,this._eventQueue=o,this._logger=new We(l),this._applyDefaultsInModel(),"create"===u&&(this.queueEvent(new i),"deps"===this.changeEventBehaviour?this.queueEvent(new r({changes:[]})):this.queueEvent(new n)),this._ids=function*(e=50){const t=function(){const t=[];for(let n=0;n<e;n++)t.push(de(10));return t},n={};let i=t();do{let e=i.pop();for(;e in n;)0===i.length&&(i=t()),e=i.pop();n[e]=!0,yield i.pop(),0===i.length&&(i=t())}while(i.length>0)}(),this._bindToDataModel(new G("$form",{})),this._initialize(u),"create"===u&&this.queueEvent(new a)}_applyDefaultsInModel(){const e=this.specVersion;this._jsonModel.properties=this._jsonModel.properties||{},this._jsonModel.fieldType=this._jsonModel.fieldType||"form",(e.lessThan(ot)||"string"!=typeof this._jsonModel.properties["fd:changeEventBehaviour"])&&(this._jsonModel.properties["fd:changeEventBehaviour"]="self")}_logger;get activeField(){return this._findActiveField(this)}_findActiveField(e){return e?.isContainer?this._findActiveField(e?.activeChild):e}get logger(){return this._logger}get changeEventBehaviour(){return"deps"===this.properties["fd:changeEventBehaviour"]?"deps":"self"}dataRefRegex=/("[^"]+?"|[^.]+?)(?:\.|$)/g;get metaData(){const e=this._jsonModel.metadata||{};return new Le(e)}get action(){return this._jsonModel.action}importData(e){this._bindToDataModel(new G("$form",e)),this.syncDataAndFormModel(this.getDataNode()),this._eventQueue.runPendingQueue()}exportData(){return this.getDataNode()?.$value}setAdditionalSubmitMetadata(e){this.additionalSubmitMetadata={...this.additionalSubmitMetadata,...e}}get specVersion(){if("string"!=typeof this._jsonModel.adaptiveform)return at;try{return new rt(this._jsonModel.adaptiveform)}catch(e){return console.log(e),console.log("Falling back to default version"+at.toString()),at}}resolveQualifiedName(e){let t=null;return this.visit((n=>{n.qualifiedName===e&&(t=n)})),t}exportSubmitMetaData(){const e={};this.visit((t=>{"captcha"===t.fieldType&&(e[t.qualifiedName]=t.value)}));const t={lang:this.lang,captchaInfo:e,...this.additionalSubmitMetadata};return new Qe(t)}#s(e){return e.filter((e=>!0===e.visible))}#r(e){const t=this.#s(e.items);return t?t[0]:null}#a(e){if(!e.isContainer){return void(e.parent.activeChild=e)}this.#o(e);let t=e.activeChild;t=null===t?this.#r(e):e.activeChild,this.#a(t)}#l(e,t){return e<t.length-1?t[e+1]:null}#u(e,t){return e>0?t[e-1]:null}#o(e){const t=e.parent;null!=t&&null!=t.activeChild&&(t.activeChild=null)}setFocus(e,t){if(!t)return this.#o(e),void this.#a(e);const n=e?.isContainer?e:e.parent,i=this.#s(n.items);let s=n.activeChild,r=null!==s?i.indexOf(s):-1;if(null===n.activeChild)return this.#a(i[0]),void(r=0);t===o.NEXT_ITEM?s=this.#l(r,i):t===o.PREVIOUS_ITEM&&(s=this.#u(r,i)),null!==s&&this.#a(s)}getState(e=!1){const t=this,n=super.getState(!1,e);return n.id="$form",Object.defineProperty(n,"data",{get:function(){return t.exportData()}}),Object.defineProperty(n,"attachments",{get:function(){return he(t)}}),n}get type(){return"object"}isTransparent(){return!1}get form(){return this}get ruleEngine(){return this._ruleEngine}getUniqueId(){return null==this._ids?"":this._ids.next().value}fieldAdded(e){"captcha"!==e.fieldType||this._captcha||(this._captcha=e),this._fields[e.id]=e,e.subscribe((e=>{-1===this._invalidFields.indexOf(e.target.id)&&this._invalidFields.push(e.target.id)}),"invalid"),e.subscribe((e=>{const t=this._invalidFields.indexOf(e.target.id);t>-1&&this._invalidFields.splice(t,1)}),"valid"),e.subscribe((e=>{const t=e.target.getState();if(e.payload.changes.length>0&&t){const n=e=>e&&"object"==typeof e?Array.isArray(e)?e.map(n):{...e}:e,i=e.payload.changes.map((({propertyName:e,currentValue:t,prevValue:i})=>({propertyName:e,currentValue:n(t),prevValue:n(i)}))),s=new l(i,t,e.payload.eventSource);this.notifyDependents(s)}}))}visit(e){this.traverseChild(this,e)}traverseChild(e,t){e.items.forEach((e=>{e.isContainer&&this.traverseChild(e,t),t(e)}))}validate(){const e=super.validate();return this.dispatch(new u(e)),e}isValid(){return 0===this._invalidFields.length}dispatch(e){"submit"===e.type?(super.queueEvent(e),this._eventQueue.runPendingQueue()):super.dispatch(e)}submit(e,t){const n=e?.payload?.validate_form;if(!n||0===this.validate().length){const n=e?.payload||{},i=n?.success?n?.success:"submitSuccess",s=n?.error?n?.error:"submitError",r=n.action||this.action,a=n.metadata||{submitMetadata:this.exportSubmitMetaData()};(async(e,t,n,i="multipart/form-data",s=null,r="",a=null)=>{const o=r||e.form.action;let l=s;"object"==typeof l&&null!=l||(l=e.form.exportData());const u=he(e.form,!0);let d=i;const h={data:l,...a};let c=h;(Object.keys(u).length>0||"multipart/form-data"===i)&&(c=tt(h,u),d="multipart/form-data"),await Ye(e,o,"POST",c,t,n,{"Content-Type":d})})(t,i,s,n?.save_as||n?.submit_as,n?.data,r,a)}}save(e,t){const n=e?.payload||{};n.save_as="multipart/form-data",n.metadata={draftMetadata:{lang:this.lang,draftId:this.properties?.draftId||""}},n.success="custom:saveSuccess",n.error="custom:saveError",this.submit(e,t),this.subscribe((e=>{this._saveSuccess(e)}),"saveSuccess")}_saveSuccess(e){const t=e?.payload?.body?.draftId||"",n=this.properties;t&&n&&(n.draftId=t)}reset(){super.reset(),this._invalidFields=[]}getElement(e){return e==this.id?this:this._fields[e]}get qualifiedName(){return"$form"}getEventQueue(){return this._eventQueue}get name(){return"$form"}get value(){return null}get id(){return this._jsonModel.id||"$form"}get title(){return this._jsonModel.title||""}get captcha(){return this._captcha}}function ut(e){if(null==e){const t=(new Intl.DateTimeFormat).resolvedOptions();e=t.locale}return t=>function(e,t){if(null===e)return 0;const n=+e;if(!isNaN(n))return n;if(t){const n=N(e,t,!0);if(n!==e)return I(n)}return 0}(t,e)}class dt{_context;_globalNames=["$form","$field","$event"];customFunctions;debugInfo=[];constructor(){this.customFunctions=st.getFunctions()}compileRule(e,t){const n=new $(this.customFunctions,ut(t),this.debugInfo);return{formula:n,ast:n.compile(e,this._globalNames)}}execute(e,t,n,i=!1){const{formula:s,ast:r}=e,a=this._context;let o;this._context=n;try{o=s.run(r,t,"en-US",n)}catch(e){this._context?.form?.logger?.error(e)}for(;this.debugInfo.length>0;)this._context?.form?.logger?.debug(this.debugInfo.pop());let l=o;return i&&"object"==typeof o&&null!==o&&(l=Object.getPrototypeOf(o).valueOf.call(o)),this._context=a,l}trackDependency(e){this._context&&void 0!==this._context.field&&this._context.field!==e&&e._addDependent(this._context.field)}}class ht extends ze{constructor(e,t){super(e,t),"restore"!==t.mode&&(this._applyDefaults(),this.queueEvent(new i),this.queueEvent(new n))}_getDefaults(){return{...super._getDefaults(),visible:!0,required:!1,label:{visible:!0,richText:!1}}}_applyDefaults(){super._applyDefaultsInModel(),this._jsonModel.dataRef&&void 0===this._jsonModel.type&&(this._jsonModel.type="object")}get type(){const e=super.type;if("array"===e||"object"===e)return e}get items(){return super.items?super.items:[]}get value(){return this.getDataNode()?.$value}set value(e){if("string"==typeof this.name&&"array"===this.type){const s=new G(this._data?.$_name,e,this._data?.$_type,this._data?.parent);this._data?.parent?.$addDataNode(s.name,s,!0),this._data=s;const r=this.items.length,a=this.syncDataAndFormModel(s),o=this.items.length;a.added.forEach((e=>{this.notifyDependents(t("items",e.getState(),null)),e.dispatch(new i),e.dispatch(new n)})),a.removed.forEach((e=>{this.notifyDependents(t("items",null,e.getState()))}));for(let e=r;e<o;e+=1)this._children[e].dispatch(new n)}}get fieldType(){return"panel"}}class ct extends ht{get maxOccur(){return this._jsonModel.maxItems}set maxOccur(e){this.maxItems=e}get minOccur(){return this.minItems}addInstance(e){return this.addItem(e)}removeInstance(e){return this.removeItem(e)}}C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],ct.prototype,"maxOccur",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],ct.prototype,"minOccur",null);const pt=["string","number","integer","boolean","file","string[]","number[]","integer[]","boolean[]","file[]","array","object"];class mt extends qe{constructor(e,t){super(e,t),"restore"!==t.mode&&(this._applyDefaults(),this.queueEvent(new i),"deps"===this.form.changeEventBehaviour?this.queueEvent(new r({changes:[]})):this.queueEvent(new n))}_ruleNodeReference=[];_initialize(){super._initialize(),this.setupRuleNode()}ruleNodeReference(){return this.type?.endsWith("[]")?this._ruleNodeReference=[]:this._ruleNodeReference=this,this._ruleNodeReference}_getDefaults(){return{readOnly:!1,enabled:!0,visible:!0,label:{visible:!0,richText:!1},required:!1,type:this._getFallbackType()}}_getFallbackType(){const e=this._jsonModel.type;let t=e;if("string"!=typeof e||-1===pt.indexOf(e)){const e=this.enum;if(t=typeof e?.[0],"undefined"===t&&void 0!==this._jsonModel.default&&(t=this._jsonModel.default instanceof Array&&this._jsonModel.default.length>0?typeof this._jsonModel.default[0]+"[]":typeof this._jsonModel.default),0===t.indexOf("undefined")){t={"text-input":"string","multiline-input":"string","number-input":"number","date-input":"string",email:"string","plain-text":"string",image:"string",checkbox:"boolean"}[this.fieldType]}}return t}_applyDefaults(){super._applyDefaultsInModel(),this.coerceParam("required","boolean"),this.coerceParam("readOnly","boolean"),this.coerceParam("enabled","boolean");const e=this._jsonModel.type;"string"==typeof e&&-1!==pt.indexOf(e)||(this._jsonModel.type=this._getFallbackType()),-1===["plain-text","image"].indexOf(this.fieldType)?this._jsonModel.value=void 0:this._jsonModel.default=this._jsonModel.default||this._jsonModel.value;if(void 0===this._jsonModel.value){const e=Te.type(this.getInternalType()||"string",this._jsonModel.default);this._jsonModel.value=e.value}if("string"!==this._jsonModel.type&&this.unset("emptyValue"),void 0===this._jsonModel.fieldType&&(this.form.logger.debug("fieldType property is mandatory. Please ensure all the fields have a fieldType"),this._jsonModel.viewType?(this._jsonModel.viewType.startsWith("custom:")?this.form.logger.error("viewType property has been removed. For custom types, use :type property"):this.form.logger.error("viewType property has been removed. Use fieldType property"),this._jsonModel.fieldType=this._jsonModel.viewType):this._jsonModel.fieldType=q(this._jsonModel)),void 0===this._jsonModel.enum){"boolean"===this._jsonModel.type&&(this._jsonModel.enum=[!0,!1])}else for(void 0===this._jsonModel.enumNames&&(this._jsonModel.enumNames=this._jsonModel.enum.map((e=>e.toString())));this._jsonModel.enumNames.length<this._jsonModel.enum.length;)this._jsonModel.enumNames.push(this._jsonModel.enum[this._jsonModel.enumNames.length].toString());const t=["minimum","maximum","exclusiveMinimum","exclusiveMaximum"];"string"!==this._jsonModel.type?this.unset("format","pattern","minLength","maxLength"):"date-input"===this._jsonModel.fieldType&&(this._jsonModel.format="date"),this.coerceParam("minLength","number"),this.coerceParam("maxLength","number"),"number"!==this._jsonModel.type&&"date"!==this._jsonModel.format&&"integer"!==this._jsonModel.type&&this.unset("step",...t),t.forEach((e=>{this.coerceParam(e,"integer"===this._jsonModel.type?"number":this._jsonModel.type)})),"number"!=typeof this._jsonModel.step&&this.coerceParam("step","number")}unset(...e){e.forEach((e=>this._jsonModel[e]=void 0))}coerceParam(e,t){const n=this._jsonModel[e];if(void 0!==n&&typeof n!==t){this.form.logger.info(`${e} is not of type ${t}. Trying to coerce.`);try{this._jsonModel[e]=((e,t)=>{let n;switch(t){case"string":return e+"";case"number":if(n=+e,!isNaN(n))return n;break;case"boolean":if("string"==typeof e)return"true"===e;if("number"==typeof e)return 0!==e}throw`${e} has invalid type. Expected : ${t}, Actual ${typeof e}`})(n,t)}catch(t){this.form.logger.warn(t),this.unset(e)}}}get editFormat(){return this.withCategory(this._jsonModel.editFormat)}get displayFormat(){return this.withCategory(this._jsonModel.displayFormat)}get displayValueExpression(){return this._jsonModel.displayValueExpression}get placeholder(){return this._jsonModel.placeholder}get readOnly(){return void 0!==this.parent.readOnly&&!0===this.parent.readOnly||this._jsonModel.readOnly}set readOnly(e){this._setProperty("readOnly",e)}get enabled(){return void 0!==this.parent.enabled?!1!==this.parent.enabled&&this._jsonModel.enabled:this._jsonModel.enabled}set enabled(e){this._setProperty("enabled",e)}get valid(){return this._jsonModel?.validity?.valid}set valid(e){const t={valid:e,...e?{}:{customConstraint:!0}};this._setProperty("valid",e),this._setProperty("validity",t)}get validity(){return this._jsonModel.validity}get emptyValue(){return"null"===this._jsonModel.emptyValue?null:""===this._jsonModel.emptyValue&&"string"===this.type?"":void 0}get enum(){return this._jsonModel.enum}set enum(e){this._setProperty("enum",e)}get enumNames(){return this._jsonModel.enumNames}set enumNames(e){this._setProperty("enumNames",e)}get required(){return this._jsonModel.required||!1}set required(e){this._setProperty("required",e)}get maximum(){if("number"===this.type||"date"===this.format||"integer"===this.type)return this._jsonModel.maximum}set maximum(e){"number"!==this.type&&"date"!==this.format&&"integer"!==this.type||this._setProperty("maximum",e)}get minimum(){if("number"===this.type||"date"===this.format||"integer"===this.type)return this._jsonModel.minimum}set minimum(e){"number"!==this.type&&"date"!==this.format&&"integer"!==this.type||this._setProperty("minimum",e)}withCategory(e){if(e){const t=e?.match(/^(?:date|num)\|/);if(null===t)return"date"===this.format?e=`date|${e}`:"number"!==this.type&&"integer"!==this.type||(e=`num|${e}`),e}return e}get editValue(){const e=this.editFormat;if(!e||!this.isNotEmpty(this.value)||!1===this.valid)return this.value;try{return T(this.value,this.lang,e)}catch(e){return this.value}}get displayValue(){if(this.displayValueExpression&&"string"==typeof this.displayValueExpression&&0!==this.displayValueExpression.length)return this.executeExpression(this.displayValueExpression);const e=this.displayFormat;if(!e||!this.isNotEmpty(this.value)||!1===this.valid)return this.value;try{return T(this.value,this.lang,e)}catch(e){return this.value}}getDataNodeValue(e){return this.isEmpty()?this.emptyValue:e}updateDataNodeAndTypedValue(e){const t=this.getDataNode();if(Oe.indexOf(this.fieldType)>-1&&void 0!==t&&t!==W)return;const n=this._getConstraintObject().type(this.getInternalType()||"string",e),i=this._setProperty("value",n.value,!1);return i.length>0&&(this._updateRuleNodeReference(n.value),void 0!==t&&t.setValue(this.getDataNodeValue(this._jsonModel.value),this._jsonModel.value,this)),i}get value(){return void 0===this._jsonModel.value?null:this._jsonModel.value}set value(e){const t=this.updateDataNodeAndTypedValue(e);let n={valid:!0},i="type";if(t?.length>0){let s={};const a=Te.type(this.getInternalType()||"string",e);if(this.parent.uniqueItems&&"array"===this.parent.type&&(n=Te.uniqueItems(this.parent.uniqueItems,this.parent.getDataNode().$value),i="uniqueItems"),a.valid&&n.valid)s=this.evaluateConstraints();else{const e=a.valid&&n.valid,t={valid:e,errorMessage:a.valid&&n.valid?"":this.getErrorMessage("type"),...e?{}:{validationMessage:e?"":this.getErrorMessage(i),validity:{valid:e,[d[i]]:!0}}};s=this._applyUpdates(["valid","errorMessage","validationMessage","validity"],t)}s.valid&&this.triggerValidationEvent(s);const o=new r({changes:t.concat(Object.values(s)),eventSource:this._eventSource});this.dispatch(o)}}reset(){const e=this.updateDataNodeAndTypedValue(this.default);if(!e)return;const t={valid:void 0,errorMessage:"",validationMessage:"",validity:{valid:void 0}},n=this._applyUpdates(["valid","errorMessage","validationMessage","validity"],t),i=new r({changes:e.concat(Object.values(n))});this.dispatch(i)}_updateRuleNodeReference(e){if(this.type?.endsWith("[]"))if(null!=e)for(e.forEach(((e,t)=>{this._ruleNodeReference[t]=e}));e.length!==this._ruleNodeReference.length;)this._ruleNodeReference.pop();else for(;0!==this._ruleNodeReference.length;)this._ruleNodeReference.pop()}getInternalType(){return this.type}valueOf(){const e=this[ke],t=void 0===e?this:e;return t.ruleEngine.trackDependency(t),t._jsonModel.value||null}toString(){const e=this[ke],t=void 0===e?this:e;return t._jsonModel.value?.toString()||""}getErrorMessage(e){const t=e,n=d[t],i=h();return this._jsonModel.constraintMessages?.[t]||((e,t=[])=>e?.replace(/\${(\d+)}/g,((e,n)=>{const i=t[n];return void 0!==i?i:e})))(i[n],[this._jsonModel[t]])}get errorMessage(){return this._jsonModel.errorMessage}set errorMessage(e){this._setProperty("errorMessage",e),this._setProperty("validationMessage",e)}get screenReaderText(){return this._jsonModel.screenReaderText}_getConstraintObject(){return Te}isArrayType(){return!!this.type&&this.type.indexOf("[]")>-1}checkEnum(e,t){if(!0===this._jsonModel.enforceEnum&&null!=e){const n=t.enum;return e instanceof Array&&this.isArrayType()?e.every((e=>n(this.enum||[],e).valid)):n(this.enum||[],e).valid}return!0}checkStep(){const e=this._jsonModel.value,t=this._jsonModel.step;if("number"==typeof t){const n=t.toString().split(".")?.[1]?.length||0,i=Math.pow(10,n),s=t*i,r=e*i,a=(this._jsonModel.minimum||this._jsonModel.default||0)*i,o=(r-a)/s,l=Math.abs(r-a)%s<.001;let u,d;return l||(u=(Math.ceil(o)*s+a)/i,d=(u-s)/i),{valid:l,next:u,prev:d}}return{valid:!0}}checkValidationExpression(){const e=this._jsonModel.validationExpression;return"string"!=typeof e||0===e.length||this.executeExpression(e)}getConstraints(){switch(this.type){case"string":switch(this.format){case"date":return De.date;case"email":return De.email;case"binary":case"data-url":return De.file;default:return De.string}case"file":return De.file;case"number":case"integer":return De.number}return this.isArrayType()?De.array:[]}get format(){if(void 0===this._jsonModel.format&&"string"===this.type)switch(this.fieldType){case"date-input":this._jsonModel.format="date";break;case"file-input":this._jsonModel.format="data-url"}return this._jsonModel.format}get enforceEnum(){return this._jsonModel.enforceEnum}get tooltip(){return this._jsonModel.tooltip}get maxLength(){return this._jsonModel.maxLength}get minLength(){return this._jsonModel.minLength}get pattern(){return this._jsonModel.pattern}get step(){if("number"===this.type||"date"===this.format)return this._jsonModel.step}get exclusiveMinimum(){if("number"===this.type||"date"===this.format||"integer"===this.type)return this._jsonModel.exclusiveMinimum}set exclusiveMinimum(e){"number"!==this.type&&"date"!==this.format&&"integer"!==this.type||(this._jsonModel.exclusiveMinimum=e)}get exclusiveMaximum(){if("number"===this.type||"date"===this.format||"integer"===this.type)return this._jsonModel.exclusiveMaximum}set exclusiveMaximum(e){"number"!==this.type&&"date"!==this.format&&"integer"!==this.type||(this._jsonModel.exclusiveMaximum=e)}get default(){return this._jsonModel.default}isNotEmpty(e){return null!=e&&""!==e}evaluateConstraints(){let e="type";const t=this._jsonModel,n=this._jsonModel.value,i=this._getConstraintObject(),s=this.getConstraints();let r=!0;if(r&&(r=i.required(this.required,n).valid&&(!this.isArrayType()||!this.required||n.length>0),e="required"),r&&this.isNotEmpty(n)){const a=s.find((e=>{if(e in t&&void 0!==t[e]){const s=t[e],r=i[e];return n instanceof Array&&this.isArrayType()?-1!==De.array.indexOf(e)?!r(s,n).valid:n.some((e=>!r(s,e).valid)):"function"==typeof r&&!r(s,n).valid}return!1}));null!=a?(r=!1,e=a):(r=this.checkEnum(n,i),e="enum",r&&"number"===this.type&&(r=this.checkStep().valid,e="step"),r&&(r=this.checkValidationExpression(),e="validationExpression"))}r||this.form.logger.info(`${e} constraint evaluation failed ${this._jsonModel[e]}. Received ${this._jsonModel.value}`);const a={valid:r,errorMessage:r?"":this.getErrorMessage(e),validationMessage:r?"":this.getErrorMessage(e),validity:{valid:r,...r?{}:{[d[e]]:!0}}};return this._applyUpdates(["valid","errorMessage","validationMessage","validity"],a)}triggerValidationEvent(e){e.validity&&this.#d()}#d(){this.validity.valid?this.dispatch(new c):this.dispatch(new p)}validate(){if(!1===this.visible)return[];const e=this.evaluateConstraints();return this.#d(),e.validity&&this.notifyDependents(new r({changes:Object.values(e)})),this.valid?[]:[new m(this.id,[this._jsonModel.errorMessage])]}importData(e){this._bindToDataModel(e);const n=this.getDataNode();if(void 0!==n&&n!==W&&n.$value!==this._jsonModel.value){const e=t("value",n.$value,this._jsonModel.value);this._jsonModel.value=n.$value,this.queueEvent(e)}}defaultDataModel(e){const t=Oe.indexOf(this.fieldType)>-1?void 0:this.getDataNodeValue(this._jsonModel.value);return new Q(e,t,this.type||"string")}getState(e=!1,t=!1){return{...super.getState(t),editFormat:this.editFormat,displayFormat:this.displayFormat,editValue:this.editValue,displayValue:this.displayValue,enabled:this.enabled,readOnly:this.readOnly}}markAsInvalid(e,t=null){const n={valid:!1,errorMessage:e,validationMessage:e,validity:{valid:!1,...null!=t?{[d[t]]:!0}:{customConstraint:!0}}},i=this._applyUpdates(["valid","errorMessage","validationMessage","validity"],n),s=new r({changes:[].concat(Object.values(i))});0!==s.payload.changes.length&&(this.triggerValidationEvent(i),this.dispatch(s))}}function ft(e,t){return e.replace(";base64",`;name=${encodeURIComponent(t)};base64`)}async function gt(e){const{name:t,size:n,type:i}=e;return await new Promise(((s,r)=>{const a=new FileReader;a.onload=e=>{s(new oe({data:ft(e.target.result,t),type:i,name:t,size:n}))},a.readAsDataURL(e.data)}))}C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})},Ae("button","image","plain-text")],mt.prototype,"readOnly",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})},Ae("image","plain-text")],mt.prototype,"enabled",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],mt.prototype,"valid",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],mt.prototype,"validity",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],mt.prototype,"enum",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],mt.prototype,"enumNames",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],mt.prototype,"required",null),C([Re("date-input","number-input")],mt.prototype,"editValue",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],mt.prototype,"value",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],mt.prototype,"errorMessage",null),C([Re("text-input","date-input","file-input","email")],mt.prototype,"format",null),C([Re("text-input")],mt.prototype,"maxLength",null),C([Re("text-input")],mt.prototype,"minLength",null),C([Re("text-input")],mt.prototype,"pattern",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],mt.prototype,"exclusiveMinimum",null),C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],mt.prototype,"exclusiveMaximum",null);class _t extends mt{_getDefaults(){return{...super._getDefaults(),accept:["audio/*","video/*","image/*","text/*","application/pdf"],maxFileSize:"2MB"}}_getFallbackType(){return"file"}get maxFileSize(){return ce(this._jsonModel.maxFileSize)}get accept(){return this._jsonModel.accept}_applyUpdates(e,t){return e.reduce(((e,n)=>{const i=this._jsonModel[n],s=t[n];return s!==i&&(e[n]={propertyName:n,currentValue:s,prevValue:i},this._jsonModel[n]=i instanceof oe&&"object"==typeof s&&"value"===n?new oe({...i,data:s.data}):s),e}),{})}getInternalType(){return this.type?.endsWith("[]")?"file[]":"file"}getDataNodeValue(e){let t=e;return null!=t&&("string"===this.type?t=t.data?.toString():"string[]"===this.type&&(t=t instanceof Array?t:[t],t=t.map((e=>e?.data?.toString())))),t}async serialize(){const e=this._jsonModel.value;if(void 0===e)return null;var t;return await(t=e instanceof Array?e:[e],Promise.all([].map.call(t,gt)))}importData(e){this._bindToDataModel(e);const n=this.getDataNode();if(void 0!==n&&n!==W){const e=n?.$value;if(null!=e){const n=Te.type(this.getInternalType(),e);n.valid||this.form.logger.debug(`unable to bind ${this.name} to data`),this.form.getEventQueue().queue(this,t("value",n.value,this._jsonModel.value)),this._jsonModel.value=n.value}else this._jsonModel.value=null}}}class yt extends mt{offValue(){const e=this.enum;return e.length>1?e[1]:null}_getConstraintObject(){const e={...super._getConstraintObject()};var t;return e.required=(t=this.offValue(),(e,n)=>({valid:Te.required(e,n).valid&&(!e||n!=t),value:n})),e}_applyDefaults(){"boolean"==typeof this._jsonModel.checked&&(this._jsonModel.checked?this._jsonModel.default=this._jsonModel.enum?.[0]:this._jsonModel.default=this._jsonModel.enum?.[1]),super._applyDefaults()}_getDefaults(){return{...super._getDefaults(),enforceEnum:!0}}get enum(){return this._jsonModel.enum||[]}updateDataNodeAndTypedValue(e){const t=super.updateDataNodeAndTypedValue(e),n=t.find((e=>"value"===e.propertyName));if(n){const e=n.prevValue===this._jsonModel.enum?.[0],i=n.currentValue===this._jsonModel.enum?.[0];e!==i&&t.push({propertyName:"checked",prevValue:e,currentValue:i})}return t}set checked(e){this.value=e?this._jsonModel.enum?.[0]:this._jsonModel.enum?.[1]}get checked(){return this.value===this._jsonModel.enum?.[0]}getState(e=!1,t=!1){return{...super.getState(e,t),checked:this.checked}}}C([function(e,t,n){const i=n.get;null!=i&&(n.get=function(){return this.ruleEngine.trackDependency(this),i.call(this)})}],yt.prototype,"checked",null);class vt extends mt{constructor(e,t){super(e,t)}_getFallbackType(){const e=super._getFallbackType();return"string"==typeof e?`${e}[]`:"string[]"}_getDefaults(){return{...super._getDefaults(),enforceEnum:!0,enum:[]}}}class bt extends mt{locale;_dataFormat="yyyy-MM-dd";_applyDefaults(){super._applyDefaults(),this.locale=(new Intl.DateTimeFormat).resolvedOptions().locale,this._jsonModel.editFormat||(this._jsonModel.editFormat="short"),this._jsonModel.displayFormat||(this._jsonModel.displayFormat=this._jsonModel.editFormat),this._jsonModel.placeholder||(this._jsonModel.placeholder=O(this._jsonModel.editFormat,this.locale)),this._jsonModel.description||(this._jsonModel.description=`To enter today's date use ${F(new Date,this.locale,this._jsonModel.editFormat)}`)}get value(){return super.value}set value(e){if("number"==typeof e){const t=k(e);isNaN(t)||(super.value=F(t,this.locale,this._dataFormat))}else super.value=e}}class Mt extends mt{_getDefaults(){return{...super._getDefaults(),format:"email"}}}class jt extends mt{_captchaDisplayMode;_captchaProvider;_captchaSiteKey;constructor(e,t){super(e,t),this._captchaDisplayMode=e.captchaDisplayMode,this._captchaProvider=e.captchaProvider,this._captchaSiteKey=e.siteKey}getDataNode(){}custom_setProperty(e){this.applyUpdates(e.payload)}get captchaDisplayMode(){return this._captchaDisplayMode}get captchaProvider(){return this._captchaProvider}get captchaSiteKey(){return this._captchaSiteKey}}class xt extends mt{click(){if(!this._events?.click&&this._jsonModel.buttonType)return"submit"===this._jsonModel.buttonType?this.form.dispatch(new b):"reset"===this._jsonModel.buttonType?this.form.dispatch(new j):void 0}}const Et={text:"text-input",number:"number-input",email:"email",file:"file-input",range:"range",textarea:"multiline-input"};const wt=new class{createField(e,t){let n;const i={...t,fieldFactory:this};if(e.fieldType=e.fieldType?e.fieldType in Et?Et[e.fieldType]:e.fieldType:"text-input",L(e)){const t={...e,..."items"in e&&{type:"object"},minOccur:void 0,maxOccur:void 0,repeatable:void 0,name:void 0},s={minItems:e.minOccur||0,maxItems:e.maxOccur||-1,fieldType:e.fieldType,type:"array",name:e.name,dataRef:e.dataRef,events:{"custom:setProperty":"$event.payload"},items:[t]};n=new ct(s,i)}else"items"in e||"panel"===e.fieldType?n=new ht(e,i):V(e)||"file-input"===e.fieldType?n=new _t(e,i):(s=e,n="checkbox"===(s?.fieldType||q(s))?new yt(e,i):function(e){return"checkbox-group"===(e?.fieldType||q(e))}(e)?new vt(e,i):function(e){const t=e?.fieldType||q(e);return"text-input"===t&&"email"===e?.format||"email"===t}(e)?new Mt(e,i):function(e){const t=e?.fieldType||q(e);return"text-input"===t&&"date"===e?.format||"date-input"===t}(e)?new bt(e,i):function(e){return"captcha"===(e?.fieldType||q(e))}(e)?new jt(e,i):function(e){return"button"===e?.fieldType}(e)?new xt(e,i):new mt(e,i));var s;return n}},Dt=(e,t,n="error",i=void 0)=>{try{let s=i;null==s&&(e=ge(e),s=new lt({...e},wt,new dt,new Je(new We(n)),n));const r=e?.data;return r&&s.importData(r),"function"==typeof t&&t(s),s.getEventQueue().runPendingQueue(),s}catch(e){throw console.error(`Unable to create an instance of the Form ${e}`),new Error(e)}};Dt.currentVersion=at;const $t={logLevel:"error"},Tt=(e,t=null,{logLevel:n}=$t)=>{try{const i=new lt({...e},wt,new dt,new Je(new We(n)),n,"restore");return t&&(i._bindToDataModel(new G("$form",t)),i.syncDataAndFormModel(i.getDataNode())),i.getEventQueue().empty(),i}catch(e){throw console.error(`Unable to restore an instance of the Form ${e}`),new Error(e)}},Nt=(e,t)=>{try{const n=new lt({...e},wt,new dt);return t&&n.importData(t),0===n.validate().length}catch(e){throw new Error(e)}},It=(e,t)=>{try{const n=new lt({...e},wt,new dt);t&&n.importData(t);const i=n.validate();return{messages:i,valid:0===i.length}}catch(e){throw new Error(e)}},Ot=(e,t={})=>{const n=new Headers;return Object.entries(t).forEach((([e,t])=>{n.append(e,t)})),new Promise(((n,i)=>{Ke(`${e}.model.json`,null,{headers:t}).then((e=>{if(200!==e.status)i("Not Found");else{let t=e.body;if("model"in t){const{model:e}=t;t=e}n(U(t))}}))}))},Ft=e=>{st.registerFunctions(e)};export{Dt as createFormInstance,Ot as fetchForm,Ft as registerFunctions,Tt as restoreFormInstance,It as validateFormData,Nt as validateFormInstance};
